from stix2.properties import (
    StringProperty,
    FloatProperty,
    BooleanProperty,
    EnumProperty,
)

from stix2extensions.automodel import (
    AutomodelExtensionBase,
    automodel,
    extend_property,
)
from stix2extensions.automodel.property_extension import (
    CustomPropertyExtension,
    ExtensionTypes,
)


@automodel
@CustomPropertyExtension(
    "vulnerability-opencti",
    [
        # =========================
        # CVSS v2
        # =========================
        (
            "x_opencti_cvss_v2_base_score",
            extend_property(
                FloatProperty(min=0, max=10),
                description="CVSS v2 Base Score (0.0 - 10.0).",
                examples=[8.5],
            ),
        ),
        (
            "x_opencti_cvss_v2_temporal_score",
            extend_property(
                FloatProperty(min=0, max=10),
                description="CVSS v2 Temporal Score (0.0 - 10.0), reflecting exploit code maturity, remediation, and report confidence at a point in time.",
                examples=[8.5],
            ),
        ),
        (
            "x_opencti_cvss_v2_vector_string",
            extend_property(
                StringProperty(),
                description="CVSS v2 vector string",
                examples=["AV:N/AC:L/Au:N/C:P/I:P/A:P"],
            ),
        ),
        (
            "x_opencti_cvss_v2_base_severity",
            extend_property(
                EnumProperty(allowed=["LOW", "MEDIUM", "HIGH"]),
                description="CVSS v2.0 Base Severity.",
            ),
        ),
        (
            "x_opencti_cvss_v2_access_vector",
            extend_property(
                EnumProperty(allowed=["NETWORK", "ADJACENT_NETWORK", "LOCAL"]),
                description="CVSS v2 Access Vector (AV). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v2_access_complexity",
            extend_property(
                EnumProperty(allowed=["HIGH", "MEDIUM", "LOW"]),
                description="CVSS v2 Access Complexity (AC). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v2_authentication",
            extend_property(
                EnumProperty(allowed=["MULTIPLE", "SINGLE", "NONE"]),
                description="CVSS v2 Authentication (Au). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v2_confidentiality_impact",
            extend_property(
                EnumProperty(allowed=["NONE", "PARTIAL", "COMPLETE"]),
                description="CVSS v2 Confidentiality Impact (C). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v2_integrity_impact",
            extend_property(
                EnumProperty(allowed=["NONE", "PARTIAL", "COMPLETE"]),
                description="CVSS v2 Integrity Impact (I). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v2_availability_impact",
            extend_property(
                EnumProperty(allowed=["NONE", "PARTIAL", "COMPLETE"]),
                description="CVSS v2 Availability Impact (A). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v2_exploitability",
            extend_property(
                EnumProperty(
                    allowed=[
                        "UNPROVEN",
                        "PROOF_OF_CONCEPT",
                        "FUNCTIONAL",
                        "HIGH",
                        "NOT_DEFINED",
                    ]
                ),
                description="CVSS v2 Temporal metric: Exploitability",
            ),
        ),
        (
            "x_opencti_cvss_v2_remediation_level",
            extend_property(
                EnumProperty(
                    allowed=[
                        "OFFICIAL_FIX",
                        "TEMPORARY_FIX",
                        "WORKAROUND",
                        "UNAVAILABLE",
                        "NOT_DEFINED",
                    ]
                ),
                description="CVSS v2 Temporal metric: Remediation Level",
            ),
        ),
        (
            "x_opencti_cvss_v2_report_confidence",
            extend_property(
                EnumProperty(
                    allowed=[
                        "UNCONFIRMED",
                        "UNCORROBORATED",
                        "CONFIRMED",
                        "NOT_DEFINED",
                    ]
                ),
                description="CVSS v2 Temporal metric: Report Confidence",
            ),
        ),
        # =========================
        # CVSS v3.x
        # =========================
        (
            "x_opencti_cvss_base_score",
            extend_property(
                FloatProperty(min=0, max=10),
                description="CVSS v3.x Base Score (0.0 - 10.0).",
                examples=[8.5],
            ),
        ),
        (
            "x_opencti_cvss_temporal_score",
            extend_property(
                FloatProperty(min=0, max=10),
                description="CVSS v3.x Temporal Score (0.0 - 10.0), incorporating exploit code maturity, remediation level, and report confidence.",
                examples=[8.5],
            ),
        ),
        (
            "x_opencti_cvss_vector_string",
            extend_property(
                StringProperty(),
                description="CVSS v3.x vector string",
                examples=["CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"],
            ),
        ),
        (
            "x_opencti_cvss_base_severity",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "MEDIUM", "HIGH", "CRITICAL"]),
                description="CVSS v3.x Base Severity.",
            ),
        ),
        (
            "x_opencti_cvss_attack_vector",
            extend_property(
                EnumProperty(
                    allowed=["NETWORK", "ADJACENT_NETWORK", "LOCAL", "PHYSICAL"]
                ),
                description="CVSS v3.x Attack Vector (AV). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_attack_complexity",
            extend_property(
                EnumProperty(allowed=["HIGH", "LOW"]),
                description="CVSS v3.x Attack Complexity (AC). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_privileges_required",
            extend_property(
                EnumProperty(allowed=["HIGH", "LOW", "NONE"]),
                description="CVSS v3.x Privileges Required (PR). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_user_interaction",
            extend_property(
                EnumProperty(allowed=["NONE", "REQUIRED"]),
                description="CVSS v3.x User Interaction (UI). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_scope",
            extend_property(
                EnumProperty(allowed=["UNCHANGED", "CHANGED"]),
                description="CVSS v3.x Scope (S). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_confidentiality_impact",
            extend_property(
                EnumProperty(allowed=["N", "L", "H"]),
                description="CVSS v3.x Confidentiality Impact (C). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_integrity_impact",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v3.x Integrity Impact (I). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_availability_impact",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v3.x Availability Impact (A). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_exploit_code_maturity",
            extend_property(
                EnumProperty(
                    allowed=[
                        "UNPROVEN",
                        "PROOF_OF_CONCEPT",
                        "FUNCTIONAL",
                        "HIGH",
                        "NOT_DEFINED",
                    ]
                ),
                description="CVSS v3.x Temporal metric: Exploit Code Maturity.",
            ),
        ),
        (
            "x_opencti_cvss_remediation_level",
            extend_property(
                EnumProperty(
                    allowed=[
                        "OFFICIAL_FIX",
                        "TEMPORARY_FIX",
                        "WORKAROUND",
                        "UNAVAILABLE",
                        "NOT_DEFINED",
                    ]
                ),
                description="CVSS v3.x Temporal metric: Remediation Level.",
            ),
        ),
        (
            "x_opencti_cvss_report_confidence",
            extend_property(
                EnumProperty(
                    allowed=["UNKNOWN", "REASONABLE", "CONFIRMED", "NOT_DEFINED"]
                ),
                description="CVSS v3.x Temporal metric: Report Confidence.",
            ),
        ),
        # =========================
        # CVSS v4.0
        # =========================
        (
            "x_opencti_cvss_v4_base_score",
            extend_property(
                FloatProperty(min=0, max=10),
                description="CVSS v4.0 Base Score (0.0 - 10.0).",
                examples=[8.5],
            ),
        ),
        (
            "x_opencti_cvss_v4_vector_string",
            extend_property(
                StringProperty(),
                description="CVSS v4.0 vector string",
                examples=["CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:H"],
            ),
        ),
        (
            "x_opencti_cvss_v4_base_severity",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "MEDIUM", "HIGH", "CRITICAL"]),
                description="CVSS v4.0 Base Severity.",
            ),
        ),
        (
            "x_opencti_cvss_v4_attack_vector",
            extend_property(
                EnumProperty(allowed=["NETWORK", "ADJACENT", "LOCAL", "PHYSICAL"]),
                description="CVSS v4.0 Attack Vector (AV). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_attack_complexity",
            extend_property(
                EnumProperty(allowed=["HIGH", "LOW"]),
                description="CVSS v4.0 Attack Complexity (AC). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_attack_requirements",
            extend_property(
                EnumProperty(allowed=["NONE", "PRESENT"]),
                description="CVSS v4.0 Attack Requirements (AT). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_privileges_required",
            extend_property(
                EnumProperty(allowed=["HIGH", "LOW", "NONE"]),
                description="CVSS v4.0 Privileges Required (PR). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_user_interaction",
            extend_property(
                EnumProperty(allowed=["NONE", "PASSIVE", "ACTIVE"]),
                description="CVSS v4.0 User Interaction (UI). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_confidentiality_impact_v",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v4.0 Vulnerable System Confidentiality (VC). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_confidentiality_impact_s",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v4.0 Subsequent System Confidentiality (SC). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_integrity_impact_v",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v4.0 Vulnerable System Integrity (VI). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_integrity_impact_s",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v4.0 Subsequent System Integrity (SI). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_availability_impact_v",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v4.0 Vulnerable System Availability (VA). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_availability_impact_s",
            extend_property(
                EnumProperty(allowed=["NONE", "LOW", "HIGH"]),
                description="CVSS v4.0 Subsequent System Availability (SA). Not required if vector string passed.",
            ),
        ),
        (
            "x_opencti_cvss_v4_exploit_maturity",
            extend_property(
                EnumProperty(
                    allowed=[
                        "UNREPORTED",
                        "PROOF_OF_CONCEPT",
                        "ATTACKED",
                        "NOT_DEFINED",
                    ]
                ),
                description="CVSS v4.0 Supplemental: Exploit Maturity.",
            ),
        ),
        # =========================
        # CWE / CISA / EPSS
        # =========================
        (
            "x_opencti_cwe",
            extend_property(
                StringProperty(),
                description="Primary CWE identifier associated with the vulnerability.",
                examples=["CWE-79"],
            ),
        ),
        (
            "x_opencti_cisa_kev",
            extend_property(
                BooleanProperty(),
                description="True if the CVE is listed in CISA's Known Exploited Vulnerabilities (KEV) catalog; otherwise false.",
                examples=[True],
            ),
        ),
        (
            "x_opencti_epss_score",
            extend_property(
                FloatProperty(min=0, max=1),
                description="EPSS score (0.0 - 1.0) estimating the probability of exploitation in the wild.",
                examples=[0.11],
            ),
        ),
        (
            "x_opencti_epss_percentile",
            extend_property(
                FloatProperty(min=0, max=1),
                description="EPSS percentile (0.0 - 1.0) indicating how the EPSS score ranks relative to other vulnerabilities.",
                examples=[0.11],
            ),
        ),
    ],
    extension_type=ExtensionTypes.TOPLEVEL_PROPERTY_EXTENSION,
)
class VulnerabilityOpenCTIPropertiesExtension(AutomodelExtensionBase):
    base_schema_ref = "https://github.com/oasis-open/cti-stix2-json-schemas/raw/refs/heads/master/schemas/sdos/vulnerability.json"
    extension_name = "Vulnerability SDO Scoring Properties"
    extension_description = (
        "This extension adds new properties to Vulnerability SDOs to provide scoring."
    )
