from typing import OrderedDict
from stix2.v21.base import _STIXBase21
from stix2.properties import (
    ListProperty,
    EmbeddedObjectProperty,
    FloatProperty,
    StringProperty,
    EnumProperty,
)

from stix2extensions.automodel import (
    automodel,
    extend_property,
    AutomodelExtensionBase,
)
from stix2extensions.automodel.property_extension import (
    CustomPropertyExtension,
    ExtensionTypes,
)


# =========================
# CVSS v2.0 Property
# =========================
class CVSSv2Property(_STIXBase21):
    _properties = OrderedDict(
        [
            (
                "vector_string",
                extend_property(
                    StringProperty(required=True),
                    description="CVSS v2 vector string",
                    examples=["AV:N/AC:L/Au:N/C:P/I:P/A:P"],
                ),
            ),
            (
                "exploitability_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Exploitability Score",
                    examples=[8.5],
                ),
            ),
            (
                "impact_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Impact Score",
                    examples=[8.5],
                ),
            ),
            (
                "base_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Base Score",
                    examples=[8.5],
                ),
            ),
            (
                "base_severity",
                extend_property(
                    EnumProperty(allowed=["NONE", "LOW", "MEDIUM", "HIGH"]),
                    description="CVSS v2 Base Severity.",
                ),
            ),
            (
                "source",
                extend_property(
                    StringProperty(),
                    description="The source of the analysis. This is usually a CNA.",
                    examples=["134c704f-9b21-4f2e-91b3-4a467353bcc0"],
                ),
            ),
            (
                "type",
                extend_property(
                    StringProperty(required=True),
                    description="The type of analysis.",
                    examples=["Primary"],
                ),
            ),
        ]
    )


# =========================
# CVSS v3.0 Property
# =========================
class CVSSv3Property(_STIXBase21):
    _properties = OrderedDict(
        [
            (
                "vector_string",
                extend_property(
                    StringProperty(required=True),
                    description="The CVSS v3.0 vector string",
                    examples=["CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"],
                ),
            ),
            (
                "exploitability_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Exploitability Score",
                    examples=[8.5],
                ),
            ),
            (
                "impact_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Impact Score",
                    examples=[8.5],
                ),
            ),
            (
                "base_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Base Score",
                    examples=[8.5],
                ),
            ),
            (
                "base_severity",
                extend_property(
                    EnumProperty(allowed=["NONE", "LOW", "MEDIUM", "HIGH", "CRITICAL"]),
                    description="CVSS v3.0 Base Severity.",
                ),
            ),
            (
                "source",
                extend_property(
                    StringProperty(),
                    description="The source of the analysis. This is usually a CNA.",
                    examples=["134c704f-9b21-4f2e-91b3-4a467353bcc0"],
                ),
            ),
            (
                "type",
                extend_property(
                    StringProperty(required=True),
                    description="The type of analysis.",
                    examples=["Primary"],
                ),
            ),
        ]
    )


# =========================
# CVSS v3.1 Property
# =========================
class CVSSv31Property(_STIXBase21):
    _properties = OrderedDict(
        [
            (
                "vector_string",
                extend_property(
                    StringProperty(required=True),
                    description="The CVSS v3.1 vector string",
                    examples=["CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"],
                ),
            ),
            (
                "exploitability_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Exploitability Score",
                    examples=[8.5],
                ),
            ),
            (
                "impact_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Impact Score",
                    examples=[8.5],
                ),
            ),
            (
                "base_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Base Score",
                    examples=[8.5],
                ),
            ),
            (
                "base_severity",
                extend_property(
                    EnumProperty(allowed=["NONE", "LOW", "MEDIUM", "HIGH", "CRITICAL"]),
                    description="CVSS v3.1 Base Severity.",
                ),
            ),
            (
                "source",
                extend_property(
                    StringProperty(),
                    description="The source of the analysis. This is usually a CNA.",
                    examples=["134c704f-9b21-4f2e-91b3-4a467353bcc0"],
                ),
            ),
            (
                "type",
                extend_property(
                    StringProperty(required=True),
                    description="The type of analysis.",
                    examples=["Primary"],
                ),
            ),
        ]
    )


# =========================
# CVSS v4.0 Property
# =========================
class CVSSv4Property(_STIXBase21):
    _properties = OrderedDict(
        [
            (
                "vector_string",
                extend_property(
                    StringProperty(required=True),
                    description="The CVSS v4.0 vector string",
                    examples=[
                        "CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:L/VI:L/VA:L/SC:N/SI:N/SA:N/E:P/"
                        "CR:X/IR:X/AR:X/MAV:X/MAC:X/MAT:X/MPR:X/MUI:X/MVC:X/MVI:X/MVA:X/"
                        "MSC:X/MSI:X/MSA:X/S:X/AU:X/R:X/V:X/RE:X/U:X"
                    ],
                ),
            ),
            (
                "base_score",
                extend_property(
                    FloatProperty(min=0, max=10),
                    description="The Base Score",
                    examples=[8.5],
                ),
            ),
            (
                "base_severity",
                extend_property(
                    EnumProperty(allowed=["NONE", "LOW", "MEDIUM", "HIGH", "CRITICAL"]),
                    description="CVSS v4.0 Base Severity.",
                ),
            ),
            (
                "source",
                extend_property(
                    StringProperty(),
                    description="The source of the analysis. This is usually a CNA.",
                    examples=["134c704f-9b21-4f2e-91b3-4a467353bcc0"],
                ),
            ),
            (
                "type",
                extend_property(
                    StringProperty(required=True),
                    description="The type of analysis.",
                    examples=["Primary"],
                ),
            ),
        ]
    )


# =========================
# Full CVSS Property (aggregator)
# =========================
class FullCVSSProperty(_STIXBase21):
    _properties = OrderedDict(
        [
            ("v2_0", ListProperty(EmbeddedObjectProperty(type=CVSSv2Property))),
            ("v3_0", ListProperty(EmbeddedObjectProperty(type=CVSSv3Property))),
            ("v3_1", ListProperty(EmbeddedObjectProperty(type=CVSSv31Property))),
            ("v4_0", ListProperty(EmbeddedObjectProperty(type=CVSSv4Property))),
        ]
    )


@automodel
@CustomPropertyExtension(
    "vulnerability-scoring",
    [
        # ==== x_cvss ====
        ("x_cvss", EmbeddedObjectProperty(type=FullCVSSProperty))
    ],
    extension_type=ExtensionTypes.TOPLEVEL_PROPERTY_EXTENSION,
)
class VulnerabilityScoringExtension(AutomodelExtensionBase):
    base_schema_ref = "https://github.com/oasis-open/cti-stix2-json-schemas/raw/refs/heads/master/schemas/sdos/vulnerability.json"
    extension_name = "Vulnerability SDO Scoring Properties"
    extension_description = (
        "This extension adds new properties to Vulnerability SDOs to provide scoring."
    )


# print(VulnerabilityScoringExtension.schema)
# print(VulnerabilityScoringExtension.extension_definition)
# print(VulnerabilityScoringExtension(x_cvss={"v2_0": [{"type": "Primary", "vector_string": "My Vector String"}]}))
